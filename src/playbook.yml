---
- name: Install and configure PostgreSQL
  hosts: servers
  gather_facts: yes
  vars:
    postgres_version: 15
    postgres_data_dir: /var/lib/pgsql/data
    pg_privileges: "CREATEDB,LOGIN"
    student_password:  !vault | 
      $ANSIBLE_VAULT;1.1;AES256
      37316564316635353132616438386265366362373435363334623261343331356531383838383635
      6439613835656234643438386561663662656234373037300a343562303438643066656664616535
      34666165303865646238333564376564613162633966393662343339386537636138353630343939
      6665333737326137390a623961336431323636353833313239376636636337346164343762326438
      34346163376533343762396334656366393662643539663431393331386433303232

  tasks:
    - name: Get server load
      shell: uptime | awk '{print $10}'
      register: load_avg
      changed_when: false
    
    - name: Set load average fact
      set_fact:
        server_load: "{{ (load_avg.stdout | replace(',', '.') | float * 100) | int }}" 

    - name: output
      debug: 
        msg: "server load = {{ server_load }}"

    - name: Find server with lowest load
      set_fact:
        target_server: "{{ ansible_play_hosts | map('extract', hostvars) | list | min(attribute='server_load') }}"
      run_once: true

    - name: Determine student server
      set_fact:
        student_server: "{{ (ansible_play_hosts | map('extract', hostvars) | rejectattr('inventory_hostname', 'match', target_server.inventory_hostname) | list | first) }}"
      run_once: true

    - name: Install PostgreSQL on target server
      block:
        - name: Install PostgreSQL on Debian
          when: ansible_os_family == "Debian"
          apt:
            name:
              - "postgresql"
              - "postgresql-contrib"
              - "python3-psycopg2"
            state: present
            update_cache: yes

        - name: Install PostgreSQL on CentOS/AlmaLinux
          when: ansible_os_family == "RedHat"
          dnf:
            name:
              - "postgresql-server"
              - "postgresql-contrib"
              - "python3-psycopg2"
            state: present

        - name: Ensure data directory exists
          file:
            path: "{{ postgres_data_dir }}"
            state: directory
            owner: postgres
            group: postgres
            mode: '0700'

        - name: Initialize PostgreSQL data directory as postgres user
          become: false
          command: su - postgres -c "/usr/bin/postgresql-setup --initdb"
          when: ansible_os_family == "RedHat"

        - name: Initialize PostgreSQL data directory as postgres user
          become: false
          command: su - postgres -c "/usr/lib/postgresql/{{ postgres_version }}/bin/initdb -D {{ postgres_data_dir }}"
          when: ansible_os_family == "Debian"   
         
        - name: Enable and start PostgreSQL service
          systemd:
            name: "postgresql"
            enabled: yes
            state: started

        - name: Configure PostgreSQL to listen on all interfaces
          lineinfile:
            path: "{% if ansible_os_family == 'Debian' %}/etc/postgresql/{{ postgres_version }}/main/postgresql.conf{% else %}/var/lib/pgsql/data/postgresql.conf{% endif %}"
            regexp: '^#?listen_addresses\s*='
            line: "listen_addresses = '*'"
          notify: restart postgresql

        - name: Configure pg_hba.conf for external connections  # allow student login only from student_server
          blockinfile:
            path: "{% if ansible_os_family == 'Debian' %}/etc/postgresql/{{ postgres_version }}/main/pg_hba.conf{% else %}/var/lib/pgsql/data/pg_hba.conf{% endif %}"  
            block: |
              host    all    student    {{ student_server.inventory_hostname}}/32  md5 
              host    all    student          0.0.0.0/0                       reject
              host    all    all    0.0.0.0/0    md5
            marker: "# {mark} ANSIBLE MANAGED BLOCK"
          notify: restart postgresql

        - name: Create student user
          become: yes
          become_user: postgres
          community.postgresql.postgresql_user:
            name: student
            password: "{{ student_password }}"
            role_attr_flags: "{{ pg_privileges }}"
            login_user: postgres  # Connects as postgres DB user
            login_password: ""    # Empty if peer auth ident is configured (configured by default)
            login_unix_socket: "/var/run/postgresql"  

        - name: Test database connection
          postgresql_query:
            db: postgres
            query: SELECT 1
          become: yes
          become_user: postgres
          register: test_query

        - name: Display installation status
          debug:
            msg: |
              PostgreSQL installed on {{ inventory_hostname }} (load: {{ server_load }}).
              Student access restricted to {{ student_server.inventory_hostname }} (load: {{ student_server.server_load }}).
              Test query result: {{ test_query.query_result }}

      when: inventory_hostname == target_server.inventory_hostname

  handlers:
    - name: restart postgresql
      systemd:
        name: "postgresql"
        state: restarted
